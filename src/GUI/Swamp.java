package GUI;

import Characters.Hero;
import Logic.Game;
import Runner.MainScreen;
import com.almasb.fxgl.dsl.FXGL;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import javafx.animation.AnimationTimer;
import javafx.animation.FadeTransition;
import javafx.animation.PauseTransition;
import javafx.application.Platform;
import javafx.geometry.Point2D;
import javafx.geometry.Pos;
import javafx.geometry.Rectangle2D;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonType;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.layout.Pane;
import javafx.scene.layout.StackPane;
import javafx.scene.media.Media;
import javafx.scene.media.MediaPlayer;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.scene.text.Text;
import javafx.util.Duration;

public class Swamp {

    private final StackPane root;
    private final Pane world;
    private final StackPane loadingOverlay;
    private ImageView backgroundView;
    private MediaPlayer music;

    private final ImageView heroView;
    private final double HERO_W = 48;
    private final double HERO_H = 48;
    private final double HERO_SPEED = 180.0;
    private final Set<KeyCode> keys = new HashSet<>();
    private AnimationTimer mover;

    private final double VIEW_W = 800;
    private final double VIEW_H = 600;
    private double worldW = VIEW_W;
    private double worldH = VIEW_H;

    private Rectangle startRect;
    private boolean onStartRect = false;

    private Runnable onExitCallback;
    private final Game game;
    // Para cambiar de mapa en el mismo pantano
    private final List<Rectangle> dungeonTriggerRects = new ArrayList<>();
    private boolean beforeDungeon = true;

    // Sistema de colisiones
    private final List<Obstacle> obstacles = new ArrayList<>();
    private boolean debugEnabled = true;

    // Inventario (si se abre desde aquí se pasa this)
    private InventoryScreen inventory;

    // Direcciones del héroe (para depuración con tecla P)
    public enum Direction {
        NONE, N, NE, E, SE, S, SW, W, NW
    }
    private Direction currentDirection = Direction.NONE;

    // Tipos de obstáculos para la aldea
    private enum ObstacleType {
        BLOCK, PLANT
    }

    // Clase interna para obstáculos
    private static class Obstacle {

        final Rectangle2D collisionRect;
        final Swamp.ObstacleType type;
        final String id;

        Obstacle(Rectangle2D collision, Swamp.ObstacleType type, String id) {
            this.collisionRect = collision;
            this.type = type;
            this.id = id;
        }
    }

    public Swamp(Game game) {
        this.game = game;
        root = new StackPane();
        root.setPrefSize(VIEW_W, VIEW_H);

        world = new Pane();
        world.setPrefSize(VIEW_W, VIEW_H);

        loadingOverlay = createLoadingOverlay();

        root.getChildren().addAll(world, loadingOverlay);

        heroView = createHeroView();

        installInputHandlers();
        createMover();

        root.focusedProperty().addListener((obs, wasFocused, isFocused) -> {
            if (!isFocused) {
                clearInputState();
            }
        });
    }

    public StackPane getRoot() {
        return root;
    }

    public Point2D getHeroMapTopLeft() {
        return new Point2D(heroView.getLayoutX(), heroView.getLayoutY());
    }

    public void showWithLoading(Runnable onLoaded, Runnable onExit) {
        this.onExitCallback = onExit;

        Platform.runLater(() -> {
            FXGL.getGameScene().addUINode(root);
            showLoading(true);

            boolean imageOk = loadBackgroundImage("/Resources/textures/SwampDungeon/swampOutside.png");
            boolean musicOk = startVillageMusic("/Resources/music/swampDungeon.mp3");

            populateSwampObstacles();
            createDungeonTriggerRects();

            positionHeroAtEntrance();
            createStartRectAtHeroStart();

            PauseTransition wait = new PauseTransition(Duration.millis(600));
            wait.setOnFinished(e -> {
                showLoading(false);
                fadeInContent();
                startMover();
                if (onLoaded != null) {
                    onLoaded.run();
                }
            });
            wait.play();
        });
    }

    public void hide() {
        Platform.runLater(() -> {
            stopVillageMusic();
            stopMover();
            try {
                FXGL.getGameScene().removeUINode(root);
            } catch (Throwable ignored) {
            }
        });
    }

    public void setHeroPosition(double x, double y) {
        double nx = clamp(x, 0, Math.max(0, worldW - HERO_W));
        double ny = clamp(y, 0, Math.max(0, worldH - HERO_H));
        heroView.setLayoutX(nx);
        heroView.setLayoutY(ny);
        updateCamera();
    }

    public void startMover() {
        if (mover != null) {
            mover.start();
        }
    }

    public void stopMover() {
        if (mover != null) {
            mover.stop();
        }
    }

    public void stopVillageMusic() {
        try {
            if (music != null) {
                music.stop();
                music.dispose();
                music = null;
            }
        } catch (Throwable ignored) {
        }
    }

    // ---------------- internals / UI ----------------
    private StackPane createLoadingOverlay() {
        StackPane overlay = new StackPane();
        overlay.setPickOnBounds(true);

        Rectangle bg = new Rectangle(VIEW_W, VIEW_H);
        bg.setFill(Color.rgb(0, 0, 0, 0.6));

        Text label = new Text("Loading Terrain...");
        label.setStyle("-fx-font-size: 24px; -fx-fill: #e0d090;");

        overlay.getChildren().addAll(bg, label);
        StackPane.setAlignment(label, Pos.CENTER);
        overlay.setVisible(false);
        return overlay;
    }

    private void showLoading(boolean show) {
        loadingOverlay.setVisible(show);
        if (show) {
            loadingOverlay.toFront();
        } else {
            loadingOverlay.toBack();
        }
    }

    private void fadeInContent() {
        FadeTransition ft = new FadeTransition(Duration.millis(400), root);
        ft.setFromValue(0.2);
        ft.setToValue(1.0);
        ft.play();
    }

    private boolean loadBackgroundImage(String path) {
        try {
            Image img = new Image(getClass().getResourceAsStream(path));
            backgroundView = new ImageView(img);
            backgroundView.setPreserveRatio(false);
            backgroundView.setSmooth(true);

            worldW = img.getWidth() > 0 ? img.getWidth() : VIEW_W;
            worldH = img.getHeight() > 0 ? img.getHeight() : VIEW_H;

            backgroundView.setFitWidth(worldW);
            backgroundView.setFitHeight(worldH);

            world.setPrefSize(worldW, worldH);
            world.getChildren().clear();
            world.getChildren().add(backgroundView);

            if (!world.getChildren().contains(heroView)) {
                world.getChildren().add(heroView);
            } else {
                heroView.toFront();
            }
            return true;
        } catch (Throwable t) {
            Text err = new Text("No se pudo cargar la imagen de la Zona.");
            err.setStyle("-fx-font-size: 16px; -fx-fill: #ffdddd;");
            root.getChildren().add(err);
            return false;
        }
    }

    private boolean startVillageMusic(String path) {
        try {
            URL res = getClass().getResource(path);
            if (res == null) {
                return false;
            }
            Media media = new Media(res.toExternalForm());
            stopVillageMusic();
            music = new MediaPlayer(media);
            music.setCycleCount(MediaPlayer.INDEFINITE);
            music.setVolume(MainScreen.getVolumeSetting());
            music.play();
            return true;
        } catch (Throwable t) {
            return false;
        }
    }

    private ImageView createHeroView() {
        Image img = null;
        try {
            img = new Image(getClass().getResourceAsStream(game.getHero().getSpritePath()));
        } catch (Throwable ignored) {
            img = null;
        }
        ImageView iv = new ImageView(img);
        iv.setPreserveRatio(true);
        iv.setFitWidth(HERO_W);
        iv.setFitHeight(HERO_H);
        iv.setMouseTransparent(true);
        return iv;
    }

    // ---------------- colisiones  ----------------
    private void populateSwampObstacles() {
        obstacles.clear();

        // Todas estas posiciones son plantas (Casi todas que pereza xd)
        double[][] PLANT_COORDS = new double[][]{
            {2113.2355260000004, 1151.4595319999999},
            {2113.2355260000004, 1171.7704799999995},
            {2113.2355260000004, 1200.5547659999995},
            {2156.2172760000003, 1211.9871959999996},
            {2156.2172760000003, 1249.5347999999994},
            {2113.4229600000012, 1255.2512759999995},
            {2113.4229600000012, 1275.4631519999996},
            {2113.4229600000012, 1301.3591759999995},
            {2162.5234320000013, 1301.3591759999995},
            {2162.5234320000013, 1332.8696339999995},
            {2162.5234320000013, 1344.4810919999993},
            {2205.6542400000008, 1344.4810919999993},
            {2205.6542400000008, 1315.6280639999993},
            {2211.2499900000007, 1402.2639719999997},
            {2260.181262000001, 1445.468022},
            {2260.181262000001, 1402.297866},
            {2303.4322380000012, 1436.9345279999998},
            {2303.4322380000012, 1540.77318},
            {2303.4322380000012, 1509.079824},
            {2257.4477100000013, 1491.6279239999997},
            {2162.561880000002, 1586.7478259999996},
            {2162.561880000002, 1546.5586679999994},
            {2064.5143860000026, 1491.9617519999995},
            {2064.5143860000026, 1446.1319699999992},
            {1920.7586460000025, 1446.1319699999992},
            {1920.7586460000025, 1402.9217639999995},
            {2018.6764680000028, 1350.8251739999996},
            {2018.6764680000028, 1299.025619999999},
            {2257.6529640000026, 1681.768025999999},
            {2257.6529640000026, 1641.4224119999992},
            {2162.5826340000012, 1586.7584459999991},
            {2162.5826340000012, 1543.652945999999},
            {2018.468172000001, 1584.0477179999991},
            {2018.468172000001, 1549.3149179999994},
            {1871.4933120000005, 1580.8892219999996},
            {1871.4933120000005, 1540.5863579999998},
            {1776.386442000001, 1439.8779240000003},
            {1730.3512980000005, 1439.8779240000003},
            {1684.1501940000005, 1439.8779240000003},
            {1638.1093260000002, 1439.8779240000003},
            {1589.2590720000003, 1439.8779240000003},
            {1540.4178360000003, 1439.8779240000003},
            {1491.4356780000005, 1439.8779240000003},
            {1442.5924080000002, 1394.1003959999998},
            {1396.5533400000006, 1347.9865740000002},
            {1344.889578000001, 1347.9865740000002},
            {1344.889578000001, 1397.0489220000009},
            {1344.889578000001, 1446.034500000001},
            {1298.637912000001, 1446.034500000001},
            {1298.637912000001, 1486.4038200000011},
            {1298.637912000001, 1402.6101840000013},
            {1298.637912000001, 1356.6087180000015},
            {1586.4596579999989, 959.139000000002},
            {1586.4596579999989, 910.2376620000019},
            {1629.5878379999988, 950.449068000002},
            {1681.391945999999, 959.103054000002},
            {1681.391945999999, 910.025316000002},
            {1681.391945999999, 480.86973000000216},
            {1635.3363539999993, 380.10772800000217},
            {1586.495153999999, 336.8869560000021},
            {1778.7663659999987, 287.7384600000021},
            {1778.7663659999987, 250.3091340000021},
            {1199.871317999998, 486.58042800000226},
            {1199.871317999998, 446.1411960000022},
            {1107.5310119999983, 532.6036200000023},
            {1107.5310119999983, 495.16149600000233},
            {1052.9457599999985, 722.9853540000025},
            {865.6192919999979, 760.3816680000025},
            {1009.7327459999976, 913.0882500000025},
            {1053.0663599999978, 913.0882500000025},
            {1099.081019999998, 913.0882500000025},
            {1248.7628099999981, 869.8807980000026},
            {1300.6118639999977, 869.8807980000026},
            {1251.6812039999973, 1045.3083480000032},
            {1199.9387819999972, 1053.7636320000033},
            {1150.9350059999974, 1053.7636320000033},
            {1107.7342319999968, 1053.7636320000033},
            {1058.7122219999972, 1053.7636320000033},
            {1012.8231479999977, 1053.7636320000033},
            {390.374003999997, 912.2940180000052},
            {390.374003999997, 874.8077940000052},
            {433.4201399999971, 771.2687880000054},
            {770.554523999997, 765.0081000000057},
            {770.554523999997, 808.3051380000059},
            {243.48930599999682, 283.9788360000057},
            {243.48930599999682, 246.37957200000565},
            {243.48930599999682, 186.09543000000562},
            {431.3674559999968, 1640.8839600000047},
            {431.3674559999968, 1600.439904000005},
            {290.0766719999971, 1585.7964000000054},
            {290.0766719999971, 1542.5681040000052},
            {336.10650599999707, 1689.2960400000054},
            {336.10650599999707, 1726.8268860000055},
            {1298.192339999996, 2161.4083380000066},
            {1298.192339999996, 2118.313494000007},
            {1105.1588459999953, 2158.663248000007},
            {768.6017219999953, 1965.8039040000078},
            {768.6017219999953, 1937.008476000008},
            {627.3578279999956, 2023.681374000008},
            {627.3578279999956, 1986.0938820000079},
            {1684.0340220000012, 1249.7385600000007},
            {1732.944090000001, 1249.7385600000007},
            {771.048156000001, 1725.3278100000016},
            {719.131224000001, 1725.3278100000016},
            {673.209120000001, 1725.3278100000016},
            {629.8725000000009, 1725.3278100000016},
            {670.3352040000008, 1820.233242000002}
        };

        int idx = 1;
        for (double[] p : PLANT_COORDS) {
            double x = p[0];
            double y = p[1];
            obstacles.add(new Obstacle(
                    new Rectangle2D(x, y, 40, 40),
                    ObstacleType.PLANT,
                    "Planta" + idx
            ));
            idx++;
        }
        // Agujeros y pozos de toxinas
        double[][] TOXIC_COORDS = new double[][]{
            {2352.0, 287.20024200000074},
            {2328.823092, 287.20024200000074},
            {2305.678692, 287.20024200000074},
            {2282.7522179999996, 287.20024200000074},
            {2259.5913839999994, 287.20024200000074},
            {2248.0045139999993, 287.20024200000074},
            {2248.0045139999993, 258.3605340000007},
            {2248.0045139999993, 235.3984560000007},
            {2248.0045139999993, 215.37232200000068},
            {2248.0045139999993, 192.30456600000073},
            {2248.0045139999993, 169.24847400000073},
            {2248.0045139999993, 146.06197200000074},
            {2222.1600419999986, 146.06197200000074},
            {2196.1293779999983, 146.06197200000074},
            {2167.439285999998, 146.06197200000074},
            {2138.5408259999986, 146.06197200000074},
            {2109.6364259999978, 146.06197200000074},
            {2083.8960479999973, 146.06197200000074},
            {2049.319901999998, 146.06197200000074},
            {2023.2092459999978, 146.06197200000074},
            {1997.1245639999981, 146.06197200000074},
            {1971.246557999998, 146.06197200000074},
            {1945.173701999998, 146.06197200000074},
            {1919.2934639999978, 146.06197200000074},
            {1893.252269999998, 146.06197200000074},
            {1870.1206139999983, 146.06197200000074},
            {1846.9934579999983, 146.06197200000074},
            {1826.7387599999984, 137.47098600000072},
            {1795.1547359999984, 137.47098600000072},
            {1769.033369999998, 137.47098600000072},
            {1743.0995459999976, 137.47098600000072},
            {1711.5528539999978, 137.47098600000072},
            {1685.5728779999977, 137.47098600000072},
            {1659.7461899999973, 137.47098600000072},
            {1636.7500739999973, 137.47098600000072},
            {1636.7500739999973, 166.39043400000077},
            {1619.3667719999976, 175.14136800000077},
            {1584.7392539999973, 186.69247200000075},
            {1584.7392539999973, 209.74451400000075},
            {1584.7392539999973, 224.27636400000074},
            {1556.0889779999973, 224.27636400000074},
            {1538.7087719999975, 238.57232400000072},
            {1538.7087719999975, 270.1274580000007},
            {1515.8551079999975, 275.92183800000066},
            {1495.6971779999974, 275.92183800000066},
            {1469.7721919999974, 275.92183800000066},
            {1446.6536579999972, 275.92183800000066},
            {1423.7026139999975, 275.92183800000066},
            {1403.5102859999974, 275.92183800000066},
            {1388.9845559999976, 275.92183800000066},
            {1389.0419399999976, 301.86936000000065},
            {1389.0419399999976, 321.8936400000007},
            {1360.1713979999977, 321.8936400000007},
            {1331.2914779999978, 321.8936400000007},
            {1308.1015919999977, 321.8936400000007},
            {1287.9487919999976, 321.8936400000007},
            {1264.9250099999974, 321.8936400000007},
            {1238.7432359999978, 321.8936400000007},
            {1209.9163799999976, 321.8936400000007},
            {1187.0769899999975, 321.8936400000007},
            {1161.1019279999978, 321.8936400000007},
            {1135.0758179999978, 321.8936400000007},
            {1109.164979999998, 321.8936400000007},
            {1083.2030579999985, 321.8936400000007},
            {1060.1014439999983, 321.8936400000007},
            {1039.7742239999984, 321.8936400000007},
            {1016.8941899999986, 321.8936400000007},
            {1014.2176979999984, 344.77300800000063},
            {1014.2176979999984, 364.84527600000064},
            {996.9864779999986, 370.7080020000006},
            {976.7717759999986, 370.7080020000006},
            {962.3902799999985, 370.7080020000006},
            {936.4930139999984, 370.7080020000006},
            {916.2091739999986, 370.7080020000006},
            {916.2091739999986, 390.8329200000005},
            {907.3748099999985, 416.71868400000045},
            {873.0823799999986, 422.38542600000045},
            {873.0823799999986, 448.22412000000037},
            {864.7869899999985, 465.4627200000004},
            {864.7869899999985, 488.5197840000003},
            {864.7869899999985, 514.3757040000004},
            {893.5908419999984, 514.3757040000004},
            {916.6381319999982, 514.3757040000004},
            {959.9750759999981, 520.1233740000004},
            {959.9750759999981, 537.5183220000005},
            {959.9750759999981, 563.5533240000005},
            {994.514321999998, 563.5533240000005},
            {960.2711939999981, 606.6560340000003},
            {940.3895999999982, 612.4702680000004},
            {914.4924419999983, 612.4702680000004},
            {914.4924419999983, 632.5659180000005},
            {914.4924419999983, 652.6888020000006},
            {902.8660439999983, 658.4208300000006},
            {879.6414179999983, 658.4208300000006},
            {867.8965619999983, 672.9242760000005},
            {867.8965619999983, 690.2620740000006},
            {856.2805859999983, 710.3004480000008},
            {827.3209259999982, 710.3004480000008},
            {821.5383719999983, 710.3004480000008},
            {815.9242079999985, 721.946916000001},
            {815.9242079999985, 808.3098720000011},
            {853.5777239999985, 808.3098720000011},
            {816.1924079999986, 845.6603040000011},
            {790.3783559999987, 848.5336980000011},
            {764.5994219999988, 848.5336980000011},
            {738.4968119999988, 848.5336980000011},
            {718.243823999999, 857.350134000001},
            {718.243823999999, 889.0177320000009},
            {718.243823999999, 917.783280000001},
            {718.243823999999, 943.8127380000011},
            {689.5189019999991, 943.8127380000011},
            {660.800729999999, 943.8127380000011},
            {631.7342579999992, 949.7270160000012},
            {600.1575419999992, 949.7270160000012},
            {576.9689159999991, 949.7270160000012},
            {576.9689159999991, 981.384534000001},
            {565.5655379999992, 995.9390640000009},
            {536.755817999999, 995.9390640000009},
            {527.970269999999, 1024.8261480000008},
            {527.970269999999, 1050.847614000001},
            {487.616357999999, 1050.847614000001},
            {487.616357999999, 1079.601030000001},
            {487.616357999999, 1108.4223240000008},
            {487.616357999999, 1151.502840000001},
            {516.392723999999, 1160.249868000001},
            {536.4174719999988, 1160.249868000001},
            {559.3391759999989, 1160.249868000001},
            {582.371543999999, 1160.249868000001},
            {608.3155379999989, 1160.249868000001},
            {636.9486959999988, 1160.249868000001},
            {662.8080719999988, 1160.249868000001},
            {688.9129859999988, 1160.249868000001},
            {714.7408439999987, 1160.249868000001},
            {714.7408439999987, 1139.9522580000012},
            {714.7408439999987, 1111.1516640000011},
            {691.5699659999988, 1102.5131760000013},
            {662.8092239999987, 1102.5131760000013},
            {639.6476879999987, 1102.5131760000013},
            {616.8141839999986, 1102.5131760000013},
            {590.8094219999986, 1102.5131760000013},
            {559.1321399999987, 1102.5131760000013},
            {533.2920959999988, 1102.5131760000013},
            {533.2920959999988, 1073.7233100000014},
            {533.2920959999988, 1047.8282400000016},
            {484.25858399999856, 1238.3877600000005},
            {507.2937239999986, 1238.3877600000005},
            {527.5124399999987, 1238.3877600000005},
            {547.7066579999986, 1238.3877600000005},
            {573.7589939999986, 1238.3877600000005},
            {596.6763599999985, 1238.3877600000005},
            {625.4889779999984, 1238.3877600000005},
            {645.4780499999983, 1238.3877600000005},
            {662.7969119999984, 1238.3877600000005},
            {685.7613839999984, 1238.3877600000005},
            {703.1979659999984, 1238.3877600000005},
            {717.5904419999983, 1238.3877600000005},
            {717.5904419999983, 1261.594728000001},
            {717.5904419999983, 1276.092090000001},
            {717.5904419999983, 1293.435504000001},
            {717.5904419999983, 1319.185872000001},
            {717.5904419999983, 1345.2193440000008},
            {717.5904419999983, 1368.3447720000006},
            {717.5904419999983, 1391.4555840000005},
            {717.5904419999983, 1414.3503060000005},
            {717.5904419999983, 1428.8841900000002},
            {694.7083199999984, 1428.8841900000002},
            {668.6868359999985, 1428.8841900000002},
            {642.8120519999984, 1428.8841900000002},
            {614.1335699999983, 1428.8841900000002},
            {588.1894859999983, 1428.8841900000002},
            {565.1475959999983, 1428.8841900000002},
            {541.9846379999983, 1428.8841900000002},
            {516.0736559999982, 1428.8841900000002},
            {493.07368799999824, 1428.8841900000002},
            {470.07062399999825, 1428.8841900000002},
            {438.55845599999816, 1428.8841900000002},
            {412.52905199999816, 1428.8841900000002},
            {383.67814799999815, 1428.8841900000002},
            {352.16896799999813, 1428.8841900000002},
            {323.2006139999981, 1428.8841900000002},
            {288.93284399999806, 1428.8841900000002},
            {263.032355999998, 1428.8841900000002},
            {231.503663999998, 1428.8841900000002},
            {202.659671999998, 1428.8841900000002},
            {176.73763799999801, 1428.8841900000002},
            {147.86491799999803, 1428.8841900000002},
            {121.96874999999802, 1428.8841900000002},
            {98.93744399999804, 1428.8841900000002},
            {81.81998399999803, 1428.8841900000002},
            {53.12614799999801, 1428.8841900000002},
            {35.67242999999801, 1428.8841900000002},
            {15.401999999998004, 1428.8841900000002},
            {0.0, 1428.8841900000002},
            {0.0, 1391.3598420000005},
            {34.477830000000004, 1391.3598420000005},
            {60.525288, 1391.3598420000005},
            {92.04328800000002, 1391.3598420000005},
            {123.67467000000005, 1391.3598420000005},
            {155.47449600000007, 1391.3598420000005},
            {178.42807800000008, 1391.3598420000005},
            {207.2718540000001, 1391.3598420000005},
            {236.03587200000013, 1391.3598420000005},
            {264.8460240000001, 1391.3598420000005},
            {290.81170800000007, 1391.3598420000005},
            {319.553694, 1391.3598420000005},
            {351.25435799999997, 1391.3598420000005},
            {377.2745819999999, 1391.3598420000005},
            {403.21448999999996, 1391.3598420000005},
            {426.24315, 1391.3598420000005},
            {449.38224, 1391.3598420000005},
            {475.46109000000007, 1391.3598420000005},
            {486.80901, 1391.3598420000005},
            {486.80901, 1365.2475840000004},
            {486.80901, 1342.2628440000005},
            {486.80901, 1316.3187960000002},
            {486.80901, 1293.4166580000003},
            {486.80901, 1261.6476120000004},
            {486.80901, 1238.5026180000004},
            {1392.7574819999995, 957.535002000001},
            {1392.7574819999995, 983.494728000001},
            {1392.7574819999995, 1009.5004800000011},
            {1349.6506319999996, 1009.5004800000011},
            {1349.6506319999996, 1038.4465320000008},
            {1300.6519679999992, 1093.3252560000008},
            {1300.6519679999992, 1145.4204600000005},
            {1251.756695999999, 1145.4204600000005},
            {1214.3494379999988, 1110.8600460000002},
            {1168.3970039999986, 1110.8600460000002},
            {1156.7646299999985, 1142.5009680000005},
            {1156.7646299999985, 1180.0312020000001},
            {1156.7646299999985, 1217.4156899999998},
            {1156.7646299999985, 1243.2697379999997},
            {1128.0025919999985, 1243.2697379999997},
            {1107.762455999998, 1243.2697379999997},
            {1107.762455999998, 1271.9642039999997},
            {1107.762455999998, 1295.0144459999995},
            {1107.762455999998, 1320.6545099999994},
            {1107.762455999998, 1332.1600379999993},
            {1090.3492559999981, 1343.2779179999995},
            {1061.4887579999984, 1343.2779179999995},
            {1038.4114259999983, 1343.2779179999995},
            {1009.5914099999983, 1343.2779179999995},
            {980.8077539999983, 1343.2779179999995},
            {957.7115399999983, 1343.2779179999995},
            {917.4406439999983, 1343.2779179999995},
            {960.7774979999982, 1305.8210699999995},
            {960.7774979999982, 1282.8957659999996},
            {960.7774979999982, 1256.9389199999994},
            {960.7774979999982, 1233.9578879999992},
            {960.7774979999982, 1210.8173219999992},
            {960.7774979999982, 1187.8250039999991},
            {960.7774979999982, 1161.967949999999},
            {960.7774979999982, 1136.115935999999},
            {960.7774979999982, 1113.0190739999991},
            {960.7774979999982, 1090.0098359999988},
            {960.7774979999982, 1052.614133999999},
            {669.9459539999984, 617.9234399999973},
            {626.5289639999984, 617.9234399999973},
            {626.5289639999984, 664.0890479999973},
            {600.5201159999983, 664.0890479999973},
            {586.1026199999984, 664.0890479999973},
            {554.5491959999985, 664.0890479999973},
            {525.7701659999984, 664.0890479999973},
            {491.2157819999983, 664.0890479999973},
            {462.34487999999834, 664.0890479999973},
            {433.52529599999843, 664.0890479999973},
            {407.59769999999844, 664.0890479999973},
            {378.76146599999845, 664.0890479999973},
            {387.43381199999845, 638.1748439999974},
            {387.43381199999845, 623.7813959999974},
            {352.9798319999984, 623.7813959999974},
            {338.5431479999984, 603.4994999999973},
            {338.5431479999984, 571.6021859999973},
            {338.5431479999984, 545.5986119999973},
            {338.5431479999984, 519.6032639999974},
            {338.5431479999984, 493.6990139999974},
            {338.5431479999984, 462.03155999999746},
            {338.5431479999984, 433.2270779999974},
            {338.5431479999984, 407.27496599999745},
            {338.5431479999984, 375.46241399999735},
            {338.5431479999984, 340.9965899999973},
            {338.5431479999984, 312.18222599999723},
            {338.5431479999984, 286.2646199999973},
            {905.8146239999994, 280.3528619999973},
            {882.7155119999995, 280.3528619999973},
            {856.9682759999995, 280.3528619999973},
            {836.8684499999996, 280.3528619999973},
            {808.0272299999995, 280.3528619999973},
            {779.0654099999996, 280.3528619999973},
            {767.5264019999996, 265.9495679999973},
            {767.5264019999996, 245.83584599999733},
            {744.5724959999994, 240.1157879999973},
            {718.7378879999993, 240.1157879999973},
            {692.9685659999992, 240.1157879999973},
            {669.8092619999992, 240.1157879999973},
            {646.760783999999, 240.1157879999973},
            {623.8051499999991, 231.41894399999728},
            {595.1056619999991, 231.41894399999728},
            {569.1732059999991, 231.41894399999728},
            {543.2024639999992, 231.41894399999728},
            {525.9202859999992, 231.41894399999728},
            {623.9508419999997, 271.5413219999973},
            {623.9508419999997, 291.8618819999973},
            {623.9508419999997, 314.89379999999727},
            {623.9508419999997, 343.7411579999972},
            {623.9508419999997, 369.6450299999972},
            {649.9781219999998, 381.1218839999972},
            {687.4375079999998, 381.1218839999972},
            {719.0351939999997, 381.1218839999972},
            {759.3250979999998, 381.1218839999972},
            {765.1789319999997, 415.6447319999972},
            {765.1789319999997, 441.4893839999972},
            {765.1789319999997, 473.08067999999724},
            {765.1789319999997, 501.91673399999723},
            {765.1789319999997, 522.0617759999973},
            {736.3587179999996, 522.0617759999973},
            {722.1365579999997, 522.0617759999973},
            {722.1365579999997, 565.2606599999972},
            {476.92990199999684, 214.97282999999945},
            {476.92990199999684, 192.03607799999946},
            {476.92990199999684, 169.01533799999945},
            {476.92990199999684, 134.39759399999946},
            {505.69759199999686, 134.39759399999946},
            {528.779261999997, 134.39759399999946},
            {557.6408219999971, 134.39759399999946},
            {586.4022479999973, 134.39759399999946},
            {615.2209139999973, 134.39759399999946},
            {649.8960779999971, 134.39759399999946},
            {684.3712439999971, 134.39759399999946},
            {718.952339999997, 134.39759399999946},
            {750.5801399999971, 134.39759399999946},
            {785.1482039999969, 134.39759399999946},
            {816.8801879999969, 134.39759399999946},
            {848.4797099999969, 134.39759399999946},
            {862.9252319999969, 134.39759399999946},
            {862.9252319999969, 160.24584599999943},
            {874.3052639999969, 180.2565179999994},
            {903.1368179999968, 180.2565179999994},
            {931.9279979999968, 180.2565179999994},
            {963.5985659999968, 180.2565179999994},
            {963.5985659999968, 203.21877599999942},
            {963.5985659999968, 226.15082999999942},
            {995.2722479999969, 226.15082999999942},
            {1021.1731859999969, 226.15082999999942},
            {1047.1720259999965, 226.15082999999942},
            {1075.9944719999967, 226.15082999999942},
            {1101.8472779999968, 226.15082999999942},
            {1101.8472779999968, 249.3468719999994},
            {1101.8472779999968, 272.31190199999946},
            {1.7395499999972839, 1335.1527540000002},
            {1.7395499999972839, 1312.1275139999998},
            {1.7395499999972839, 1286.1606419999998},
            {1.7395499999972839, 1254.2454719999998},
            {1.7395499999972839, 1225.3964039999998},
            {1.7395499999972839, 1199.4408359999998},
            {1.7395499999972839, 1164.817746},
            {1.7395499999972839, 1124.5060619999997},
            {1.7395499999972839, 1098.6746039999998},
            {1.7395499999972839, 1072.804536},
            {1.7395499999972839, 1049.7438719999998},
            {1.7395499999972839, 1020.8687940000001},
            {1.7395499999972839, 994.943916},
            {1.7395499999972839, 969.1119539999999},
            {1.7395499999972839, 940.2892379999998},
            {1.7395499999972839, 914.3822699999998},
            {1.7395499999972839, 888.4204019999996},
            {1.7395499999972839, 859.4791199999996},
            {1.7395499999972839, 813.3253919999994},
            {1.7395499999972839, 767.1859019999995},
            {47.812241999997276, 818.9810639999995},
            {47.69300999999727, 476.01374399999895},
            {47.69300999999727, 452.9987099999988},
            {47.69300999999727, 441.4169879999988},
            {0.0, 481.7476439999989},
            {0.0, 449.9240399999989},
            {0.0, 378.12688199999894},
            {0.0, 343.55912399999903},
            {262.1624760000001, 473.03404199999903},
            {233.3536200000001, 473.03404199999903},
            {233.3536200000001, 458.682083999999},
            {259.43065200000007, 429.85614599999894},
            {288.260244, 449.9249219999989},
            {288.260244, 470.1545279999989},
            {476.92990199999684, 214.97282999999945},
            {476.92990199999684, 192.03607799999946},
            {476.92990199999684, 169.01533799999945},
            {476.92990199999684, 134.39759399999946},
            {505.69759199999686, 134.39759399999946},
            {528.779261999997, 134.39759399999946},
            {557.6408219999971, 134.39759399999946},
            {586.4022479999973, 134.39759399999946},
            {615.2209139999973, 134.39759399999946},
            {649.8960779999971, 134.39759399999946},
            {684.3712439999971, 134.39759399999946},
            {718.952339999997, 134.39759399999946},
            {750.5801399999971, 134.39759399999946},
            {785.1482039999969, 134.39759399999946},
            {816.8801879999969, 134.39759399999946},
            {848.4797099999969, 134.39759399999946},
            {862.9252319999969, 134.39759399999946},
            {862.9252319999969, 160.24584599999943},
            {874.3052639999969, 180.2565179999994},
            {903.1368179999968, 180.2565179999994},
            {931.9279979999968, 180.2565179999994},
            {963.5985659999968, 180.2565179999994},
            {963.5985659999968, 203.21877599999942},
            {963.5985659999968, 226.15082999999942},
            {995.2722479999969, 226.15082999999942},
            {1021.1731859999969, 226.15082999999942},
            {1047.1720259999965, 226.15082999999942},
            {1075.9944719999967, 226.15082999999942},
            {1101.8472779999968, 226.15082999999942},
            {1101.8472779999968, 249.3468719999994},
            {1101.8472779999968, 272.31190199999946},
            {1.7395499999972839, 1335.1527540000002},
            {1.7395499999972839, 1312.1275139999998},
            {1.7395499999972839, 1286.1606419999998},
            {1.7395499999972839, 1254.2454719999998},
            {1.7395499999972839, 1225.3964039999998},
            {1.7395499999972839, 1199.4408359999998},
            {1.7395499999972839, 1164.817746},
            {1.7395499999972839, 1124.5060619999997},
            {1.7395499999972839, 1098.6746039999998},
            {1.7395499999972839, 1072.804536},
            {1.7395499999972839, 1049.7438719999998},
            {1.7395499999972839, 1020.8687940000001},
            {1.7395499999972839, 994.943916},
            {1.7395499999972839, 969.1119539999999},
            {1.7395499999972839, 940.2892379999998},
            {1.7395499999972839, 914.3822699999998},
            {1.7395499999972839, 888.4204019999996},
            {1.7395499999972839, 859.4791199999996},
            {1.7395499999972839, 813.3253919999994},
            {1.7395499999972839, 767.1859019999995},
            {47.812241999997276, 818.9810639999995},
            {47.69300999999727, 476.01374399999895},
            {47.69300999999727, 452.9987099999988},
            {47.69300999999727, 441.4169879999988},
            {0.0, 481.7476439999989},
            {0.0, 449.9240399999989},
            {0.0, 378.12688199999894},
            {0.0, 343.55912399999903},
            {262.1624760000001, 473.03404199999903},
            {233.3536200000001, 473.03404199999903},
            {233.3536200000001, 458.682083999999},
            {259.43065200000007, 429.85614599999894},
            {288.260244, 449.9249219999989},
            {288.260244, 470.1545279999989},
            {0.0, 1466.8384859999987},
            {0.0, 1492.8874019999987},
            {0.0, 1518.7798619999985},
            {0.0, 1544.7405419999984},
            {0.0, 1582.2009359999984},
            {0.0, 1628.1496979999986},
            {0.0, 1662.6004199999984},
            {0.0, 1702.9691459999985},
            {0.0, 1734.6163139999987},
            {0.0, 1775.0917619999987},
            {0.0, 1821.2066459999987},
            {0.0, 1864.4290199999991},
            {0.0, 1913.4864719999985},
            {0.0, 1959.6695219999986},
            {0.0, 2005.7742179999984},
            {0.0, 2051.699723999999},
            {0.0, 2100.6179279999983},
            {0.0, 2140.9416899999997},
            {0.0, 2178.373554},
            {0.0, 2215.826748},
            {0.0, 2267.6675939999996},
            {34.579043999999996, 2267.6675939999996},
            {60.60151799999999, 2267.6675939999996},
            {97.96923000000001, 2267.6675939999996},
            {132.53023800000003, 2267.6675939999996},
            {164.12247000000005, 2267.6675939999996},
            {187.1768160000001, 2267.6675939999996},
            {204.54895800000006, 2267.6675939999996},
            {204.54895800000006, 2230.1247419999995},
            {204.54895800000006, 2201.376077999999},
            {204.54895800000006, 2166.7530779999997},
            {204.54895800000006, 2129.1930899999998},
            {204.54895800000006, 2094.6044339999994},
            {204.54895800000006, 2060.2024739999993},
            {204.54895800000006, 2025.6562439999996},
            {204.54895800000006, 1976.4521999999993},
            {172.79937000000007, 1967.8955219999991},
            {147.18627, 1959.228755999999},
            {147.18627, 1918.9279979999992},
            {147.18627, 1881.3954959999994},
            {147.18627, 1841.001839999999},
            {173.00071800000003, 1823.811209999999},
            {216.20955600000005, 1823.811209999999},
            {256.44843000000003, 1823.811209999999},
            {296.6160239999999, 1823.811209999999},
            {334.034514, 1823.811209999999},
            {371.32430400000004, 1823.811209999999},
            {411.62185800000003, 1823.811209999999},
            {449.0041500000001, 1823.811209999999},
            {477.78849, 1823.811209999999},
            {486.422226, 1803.7654559999987},
            {486.422226, 1772.1470519999984},
            {486.422226, 1740.5428319999987},
            {520.8314399999999, 1740.5428319999987},
            {532.500912, 1720.3184999999987},
            {532.500912, 1694.4107219999985},
            {532.500912, 1656.9249299999988},
            {532.500912, 1628.2124639999986},
            {532.500912, 1588.0215239999986},
            {555.479424, 1588.0215239999986},
            {567.1515599999999, 1588.0215239999986},
            {567.1515599999999, 1616.8045499999985},
            {567.1515599999999, 1633.9593599999987},
            {610.25265, 1642.6740959999986},
            {639.1267379999999, 1642.6740959999986},
            {670.7149559999998, 1642.6740959999986},
            {711.154296, 1642.6740959999986},
            {748.5315120000002, 1642.6740959999986},
            {783.1331640000002, 1642.6740959999986},
            {817.7193720000001, 1642.6740959999986},
            {849.4275060000002, 1642.6740959999986},
            {881.2328220000002, 1642.6740959999986},
            {913.0000680000003, 1642.6740959999986},
            {950.3552520000002, 1642.6740959999986},
            {982.115298, 1642.6740959999986},
            {1002.080376, 1642.6740959999986},
            {1002.080376, 1674.3755519999986},
            {1002.080376, 1700.2430819999986},
            {1002.080376, 1720.4389199999987},
            {1002.080376, 1746.3355559999989},
            {1002.080376, 1766.5682939999988},
            {979.2125640000002, 1766.5682939999988},
            {953.2381860000002, 1766.5682939999988},
            {924.2894160000001, 1766.5682939999988},
            {886.9030020000001, 1766.5682939999988},
            {872.3643480000001, 1766.5682939999988},
            {872.3643480000001, 1734.8887439999985},
            {854.977248, 1723.4884979999983},
            {826.170912, 1723.4884979999983},
            {826.170912, 1709.1463139999985},
            {811.8130860000001, 1674.6010739999986},
            {785.8384740000001, 1674.6010739999986},
            {745.592526, 1674.6010739999986},
            {711.003852, 1674.6010739999986},
            {670.6827000000001, 1674.6010739999986},
            {624.7572120000002, 1674.6010739999986},
            {590.2996140000001, 1674.6010739999986},
            {572.9785920000002, 1674.6010739999986},
            {572.9785920000002, 1706.3660699999987},
            {572.9785920000002, 1735.1750879999988},
            {572.9785920000002, 1769.5591379999987},
            {572.9785920000002, 1798.4199779999988},
            {572.9785920000002, 1824.3498779999986},
            {572.9785920000002, 1847.5009739999985},
            {555.7386780000002, 1850.2943039999984},
            {529.8387660000004, 1864.7248319999985},
            {529.8387660000004, 1890.6351479999985},
            {529.8387660000004, 1910.813093999998},
            {498.1007520000003, 1910.813093999998},
            {466.5005640000003, 1910.813093999998},
            {431.9894520000003, 1910.813093999998},
            {431.9894520000003, 1936.7392499999978},
            {417.5960580000003, 1956.9823019999978},
            {385.9167780000004, 1956.9823019999978},
            {348.44702400000034, 1956.9823019999978},
            {334.13130000000035, 1980.0265319999978},
            {334.13130000000035, 2023.2464399999978},
            {334.13130000000035, 2057.7390839999975},
            {334.13130000000035, 2083.5054359999976},
            {334.13130000000035, 2100.814991999998},
            {334.13130000000035, 2121.0132779999976},
            {365.7227220000003, 2121.0132779999976},
            {371.4166800000003, 2149.8949079999975},
            {371.4166800000003, 2181.6217979999974},
            {371.4166800000003, 2216.053511999997},
            {371.4166800000003, 2241.9782999999966},
            {371.4166800000003, 2262.0289679999964},
            {405.79144200000036, 2253.3034499999967},
            {443.31264000000044, 2253.3034499999967},
            {483.6075840000003, 2253.3034499999967},
            {498.11079600000033, 2261.9533679999963},
            {523.9607940000003, 2261.9533679999963},
            {535.4842860000003, 2238.8641739999966},
            {535.4842860000003, 2221.7240159999965},
            {561.4968420000004, 2221.7240159999965},
            {590.3486820000004, 2221.7240159999965},
            {613.5002820000004, 2221.7240159999965},
            {613.5002820000004, 2253.4968959999965},
            {645.2524440000004, 2267.9199899999967},
            {682.7502600000006, 2267.9199899999967},
            {725.7648780000006, 2267.9199899999967},
            {780.4886580000006, 2267.9199899999967},
            {809.1780120000005, 2267.9199899999967},
            {843.6522780000006, 2267.9199899999967},
            {869.6444220000005, 2267.9199899999967},
            {901.2601620000006, 2262.1090679999966},
            {929.9457900000006, 2262.1090679999966},
            {961.6622220000007, 2262.1090679999966},
            {1002.0232800000009, 2262.1090679999966},
            {1048.1286600000005, 2262.1090679999966},
            {1085.4764820000005, 2262.1090679999966},
            {1117.2062700000008, 2262.1090679999966},
            {1154.716848000001, 2262.1090679999966},
            {1189.2515580000008, 2262.1090679999966},
            {1229.602230000001, 2262.1090679999966},
            {1267.1239860000017, 2262.1090679999966},
            {1304.5687020000018, 2262.1090679999966},
            {1339.153290000002, 2262.1090679999966},
            {1379.4820560000023, 2262.1090679999966},
            {1416.855924000002, 2262.1090679999966},
            {1454.2698780000019, 2262.1090679999966},
            {1486.0972800000022, 2262.1090679999966},
            {1532.1767040000025, 2262.1090679999966},
            {1566.8130240000023, 2262.1090679999966},
            {1589.8428720000024, 2262.1090679999966},
            {1589.8428720000024, 2221.7216579999968},
            {1624.3693380000027, 2221.7216579999968},
            {1658.9189700000027, 2221.7216579999968},
            {1681.8720120000025, 2221.7216579999968},
            {1690.5953340000026, 2218.7828879999965},
            {1690.4277180000024, 2175.4734299999964},
            {1690.4277180000024, 2135.2378859999967},
            {1690.4277180000024, 2092.0561199999966},
            {1687.5111780000025, 2060.251073999997},
            {1687.5111780000025, 2014.179191999997},
            {1687.5111780000025, 1976.777297999997},
            {1687.5111780000025, 1939.3258499999974},
            {1687.5111780000025, 1904.7364559999976},
            {1687.5111780000025, 1867.401593999998},
            {1687.5111780000025, 1835.7482699999985},
            {1687.5111780000025, 1804.2058979999981},
            {1687.5111780000025, 1778.312645999998},
            {1687.5111780000025, 1766.742137999998},
            {1652.9669280000023, 1766.742137999998},
            {1621.3838580000024, 1766.742137999998},
            {1589.7160440000025, 1766.742137999998},
            {1589.7160440000025, 1729.364885999998},
            {1589.7160440000025, 1683.251693999998},
            {1552.3295040000025, 1683.251693999998},
            {1523.4831360000026, 1683.251693999998},
            {1494.7182000000025, 1683.251693999998},
            {1480.3976340000027, 1717.794179999998},
            {1480.3976340000027, 1749.410801999998},
            {1428.5277180000028, 1755.182987999998},
            {1428.5277180000028, 1723.523129999998},
            {1425.8125440000026, 1709.090801999998},
            {1425.8125440000026, 1677.3910379999982},
            {1425.8125440000026, 1648.5634079999984},
            {1425.8125440000026, 1619.7775739999984},
            {1425.8125440000026, 1596.7681559999983},
            {1440.2471400000027, 1556.4224159999983},
            {1440.2471400000027, 1556.4224159999983},
            {1615.5211679999973, 1680.8612759999978},
            {1624.0781879999972, 1715.3798219999978},
            {1673.0969759999973, 1715.3798219999978},
            {1730.5167599999975, 1686.5115119999978},
            {1764.9260279999976, 1718.201915999998},
            {1796.6328299999975, 1718.201915999998},
            {1828.1590199999976, 1718.201915999998},
            {1853.9501939999975, 1718.201915999998},
            {1879.8288479999976, 1718.201915999998},
            {1879.8288479999976, 1689.5058299999982},
            {1908.5437079999977, 1689.5058299999982},
            {1937.2428899999975, 1689.5058299999982},
            {1966.2127559999972, 1689.5058299999982},
            {1966.2127559999972, 1715.413967999998},
            {1966.2127559999972, 1744.2052919999978},
            {1966.2127559999972, 1764.3820679999978},
            {2000.775383999997, 1764.3820679999978},
            {2032.4210399999972, 1764.3820679999978},
            {2061.3410279999966, 1764.3820679999978},
            {2061.3410279999966, 1735.7152319999975},
            {2095.9465139999957, 1735.7152319999975},
            {2127.7500839999966, 1735.7152319999975},
            {2156.605019999997, 1735.7152319999975},
            {2156.605019999997, 1761.7098959999976},
            {2156.605019999997, 1787.6870459999975},
            {2156.605019999997, 1816.6159259999974},
            {1309.8659759999987, 1643.9528519999958},
            {1309.8659759999987, 1669.7339099999956},
            {1309.8659759999987, 1692.8282879999956},
            {1309.8659759999987, 1713.0106079999955},
            {1298.3869799999986, 1744.816355999995},
            {1286.7375959999986, 1770.9521579999948},
            {1266.5338919999986, 1770.9521579999948},
            {1226.2208759999985, 1779.545501999995},
            {1208.9898899999985, 1779.545501999995},
            {1237.7517479999983, 1805.412401999995},
            {1165.640489999998, 1839.8579219999945},
            {1188.572237999998, 1851.2679059999946},
            {1214.5349159999976, 1793.757437999995},
            {1119.494663999997, 1883.2316939999953},
            {1093.6192139999969, 1883.2316939999953},
            {1064.8516499999969, 1883.2316939999953},
            {1044.601739999997, 1883.2316939999953},
            {1018.7511659999968, 1883.2316939999953},
            {989.9760059999969, 1883.2316939999953},
            {969.6932819999969, 1883.2316939999953},
            {969.6932819999969, 1857.3561899999954},
            {963.8146259999968, 1819.856015999996},
            {963.8146259999968, 1805.584481999996},
            {963.8146259999968, 1906.468559999996},
            {992.5138979999969, 1906.468559999996},
            {1024.2624779999967, 1906.468559999996},
            {1049.9673419999967, 1906.468559999996},
            {1064.3950619999966, 1935.0161279999961},
            {1064.3950619999966, 1955.2942439999963},
            {1093.2915239999968, 1955.2942439999963},
            {1110.6347039999966, 1969.6742459999962},
            {1110.6347039999966, 1995.594695999996},
            {1104.8686019999966, 2007.0655919999958},
            {1104.8686019999966, 2035.9505879999958},
            {1104.8686019999966, 2056.217507999996},
            {1081.7377919999965, 2058.994871999996},
            {1055.8875779999964, 2058.994871999996},
            {1055.8875779999964, 2096.3413799999958},
            {1133.748341999997, 2006.852345999996},
            {1182.5892899999967, 2006.852345999996},
            {1214.2753019999966, 2006.852345999996},
            {1228.7629079999967, 2012.542271999996},
            {1260.3109319999967, 2012.542271999996},
            {1289.0499659999966, 2012.542271999996},
            {1320.8470559999967, 2012.542271999996},
            {1349.7529499999964, 2012.542271999996},
            {1384.374563999996, 2012.542271999996},
            {1404.479051999996, 2012.542271999996},
            {1395.7979939999962, 1989.4190939999962},
            {1410.1872839999962, 1977.808193999996},
            {1441.9107359999964, 1977.808193999996},
            {1441.9107359999964, 2006.618165999996},
            {1441.9107359999964, 2044.2750119999964},
            {1441.9107359999964, 2070.159137999996},
            {1441.9107359999964, 2093.126597999996},
            {2352.0, 1827.8631179999993},
            {2320.251906, 1827.8631179999993},
            {2294.2208100000003, 1827.8631179999993},
            {2268.1522200000004, 1827.8631179999993},
            {2244.9973800000002, 1827.8631179999993},
            {2210.48229, 1827.8631179999993},
            {2210.48229, 1853.7759539999993},
            {2210.48229, 1905.5286539999988},
            {2210.48229, 1934.3208059999988},
            {861.0111180000001, 2157.729642000001},
            {818.2172700000002, 2157.729642000001},
            {818.2172700000002, 2197.9974240000006},
            {855.6698700000003, 2197.9974240000006},
            {1467.7501620000019, 1634.190498000004},
            {1145.060472000002, 1901.8143360000047},
            {1145.060472000002, 1930.7966220000046},
            {1145.060472000002, 1956.8978280000047},
            {194.2327200000021, 1193.977818000005},
            {148.0489860000022, 1193.977818000005},
            {145.04507400000222, 1219.9143780000052},
            {145.04507400000222, 1240.1654940000053},
            {176.70297000000227, 1240.1654940000053},
            {197.00398200000225, 1240.1654940000053},
            {197.00398200000225, 1211.3969040000052},
            {721.0924680000028, 799.520598000005},
            {669.2521800000029, 810.9874260000049},
            {669.2521800000029, 767.889738000005},
            {698.2545540000028, 767.889738000005},
            {718.4374320000029, 767.889738000005},
            {194.2523940000024, 336.16605600000463},
            {194.2523940000024, 301.78989000000473},
            {156.73283400000238, 333.6802200000046},
            {127.78890600000238, 333.6802200000046},
            {93.37506600000236, 333.6802200000046},
            {61.66041600000236, 333.6802200000046},
            {47.38195200000235, 333.6802200000046},
            {192.7376760000023, 1629.888876000006},
            {166.77955200000233, 1629.888876000006},
            {140.91292200000234, 1629.888876000006},
            {140.91292200000234, 1612.7504460000057},
            {161.1464700000023, 1612.7504460000057},
            {161.1464700000023, 1586.9125080000056},
            {172.74662400000227, 1586.9125080000056},
            {195.80127600000228, 1612.676106000006}

        };
        for (double[] p : TOXIC_COORDS) {
            double x = p[0];
            double y = p[1];
            obstacles.add(new Obstacle(
                    new Rectangle2D(x, y, 25, 25),
                    ObstacleType.BLOCK,
                    "Bloqueo" + idx
            ));
            idx++;
        }

    }

    // ---------------- movimiento y entradas ----------------
    private void positionHeroAtEntrance() {
        double startX = 2352.0;
        double startY = 607.059; // tu coordenada inicial

        heroView.setLayoutX(startX);
        heroView.setLayoutY(startY);
        updateCamera();
    }

    private void createStartRectAtHeroStart() {
        if (startRect != null) {
            world.getChildren().remove(startRect);
            startRect = null;
        }

        double rx = 2352.0;
        double ry = 472.0;
        double rw = HERO_W + 8;
        double rh = (711.0 - 472.0) + HERO_H;

        startRect = new Rectangle(rx - 4, ry - 4, rw, rh);
        startRect.setFill(Color.rgb(0, 120, 255, 0.28));
        startRect.setStroke(Color.rgb(0, 80, 200, 0.9));
        startRect.setMouseTransparent(true);
        startRect.getProperties().put("tag", "exit_area");

        if (!world.getChildren().contains(startRect)) {
            world.getChildren().add(startRect);
        }
        startRect.toBack();
        heroView.toFront();
    }

    private void installInputHandlers() {
        root.addEventFilter(KeyEvent.KEY_PRESSED, ev -> {
            KeyCode k = ev.getCode();

            if (k == KeyCode.W || k == KeyCode.UP) {
                keys.add(KeyCode.W);
            }
            if (k == KeyCode.S || k == KeyCode.DOWN) {
                keys.add(KeyCode.S);
            }
            if (k == KeyCode.A || k == KeyCode.LEFT) {
                keys.add(KeyCode.A);
            }
            if (k == KeyCode.D || k == KeyCode.RIGHT) {
                keys.add(KeyCode.D);
            }

            if (k == KeyCode.P) {
                System.out.println("Hero position (Zona): (" + heroView.getLayoutX() + ", " + heroView.getLayoutY() + ")");
                System.out.println("Hero world center (aldea): (" + (heroView.getLayoutX() + HERO_W / 2) + ", " + (heroView.getLayoutY() + HERO_H / 2) + ")");

            }

            if (k == KeyCode.I || k == KeyCode.ADD || k == KeyCode.PLUS) {
                clearInputState();
                openInventory();
            }
            if (k == KeyCode.B) {
                clearInputState();
                openDebugCombat();
            }
            if (k == KeyCode.R) {
                debugEnabled = !debugEnabled;
                if (debugEnabled) {
                    drawDebugObstacles();
                } else {
                    world.getChildren().removeIf(n -> "obstacle_debug".equals(n.getProperties().get("tag")));
                }
            }
            if (k == KeyCode.ENTER) {
                checkDungeonTriggers();
                if (!beforeDungeon) {
                } else {
                    if (onStartRect) {
                        clearInputState();
                        try {
                            if (game != null && game.getHero() != null) {
                                Hero h = game.getHero();
                                h.setLastLocation(Hero.Location.SWAMP);
                                h.setLastPosX(heroView.getLayoutX());
                                h.setLastPosY(heroView.getLayoutY());
                                try {
                                    game.createSaveGame();
                                } catch (Throwable ignored) {
                                }
                            }
                        } catch (Throwable ignored) {
                        }
                        if (onExitCallback != null) {
                            hide();
                            onExitCallback.run();
                        } else {
                            hide();
                        }
                    }
                }
                ev.consume();
            }
            ev.consume();
        });

        root.addEventFilter(KeyEvent.KEY_RELEASED, ev -> {
            KeyCode k = ev.getCode();
            if (k == KeyCode.W || k == KeyCode.UP) {
                keys.remove(KeyCode.W);
            }
            if (k == KeyCode.S || k == KeyCode.DOWN) {
                keys.remove(KeyCode.S);
            }
            if (k == KeyCode.A || k == KeyCode.LEFT) {
                keys.remove(KeyCode.A);
            }
            if (k == KeyCode.D || k == KeyCode.RIGHT) {
                keys.remove(KeyCode.D);
            }
            ev.consume();
        });

        root.setFocusTraversable(true);
        root.sceneProperty().addListener((obs, oldScene, newScene) -> {
            if (newScene != null) {
                Platform.runLater(root::requestFocus);
            } else {
                clearInputState();
            }
        });
    }

    private void openInventory() {
        stopMover();

        // Pausar música localmente
        try {
            if (music != null) {
                music.pause();
            }
        } catch (Throwable ignored) {
        }

        // Pasar referencia para que InventoryScreen pueda guardar la posición y reanudar foco
        inventory = new InventoryScreen(game, this);

        inventory.setOnClose(() -> {
            Platform.runLater(() -> {
                try {
                    FXGL.getGameScene().removeUINode(inventory.getRoot());
                } catch (Throwable ignored) {
                }
                startMover();
                try {
                    if (music != null) {
                        music.play();
                    }
                } catch (Throwable ignored) {
                }
                root.requestFocus();
            });
        });

        inventory.show();
        Platform.runLater(() -> {
            try {
                inventory.getRoot().requestFocus();
            } catch (Throwable ignored) {
            }
        });
    }

    private void createMover() {
        mover = new AnimationTimer() {
            private long last = -1;

            @Override
            public void handle(long now) {
                if (last < 0) {
                    last = now;
                }
                double dt = (now - last) / 1e9;
                last = now;

                if (root.getScene() == null || !root.isFocused()) {
                    clearInputState();
                    return;
                }

                updateAndMove(dt);
            }
        };
    }

    private void updateAndMove(double dt) {
        double vx = 0;
        double vy = 0;
        if (keys.contains(KeyCode.A)) {
            vx -= HERO_SPEED;
        }
        if (keys.contains(KeyCode.D)) {
            vx += HERO_SPEED;
        }
        if (keys.contains(KeyCode.W)) {
            vy -= HERO_SPEED;
        }
        if (keys.contains(KeyCode.S)) {
            vy += HERO_SPEED;
        }

        Swamp.Direction newDir = (vx != 0 || vy != 0)
                ? directionFromVector(vx, vy) : Swamp.Direction.NONE;
        setDirectionIfChanged(newDir);

        if (vx == 0 && vy == 0) {
            checkStartIntersection();
            return;
        }

        moveHero(vx * dt, vy * dt);
    }

    private void moveHero(double dx, double dy) {
        double curX = heroView.getLayoutX();
        double curY = heroView.getLayoutY();

        double proposedX = clamp(curX + dx, 0, Math.max(0, worldW - HERO_W));
        double proposedY = clamp(curY + dy, 0, Math.max(0, worldH - HERO_H));

        Rectangle2D heroRect = new Rectangle2D(proposedX, proposedY, HERO_W, HERO_H);
        boolean collision = false;

        for (Swamp.Obstacle ob : obstacles) {
            if (heroRect.intersects(ob.collisionRect)) {
                collision = true;
                break;
            }
        }

        if (!collision) {
            heroView.setLayoutX(proposedX);
            heroView.setLayoutY(proposedY);
        } else {
            Rectangle2D heroRectX = new Rectangle2D(proposedX, curY, HERO_W, HERO_H);
            Rectangle2D heroRectY = new Rectangle2D(curX, proposedY, HERO_W, HERO_H);

            boolean canMoveX = true;
            boolean canMoveY = true;

            for (Swamp.Obstacle ob : obstacles) {
                if (heroRectX.intersects(ob.collisionRect)) {
                    canMoveX = false;
                }
                if (heroRectY.intersects(ob.collisionRect)) {
                    canMoveY = false;
                }
            }

            if (canMoveX) {
                heroView.setLayoutX(proposedX);
            }
            if (canMoveY) {
                heroView.setLayoutY(proposedY);
            }
        }

        checkStartIntersection();
        updateCamera();
    }

    private Swamp.Direction directionFromVector(double vx, double vy) {
        if (vx == 0 && vy == 0) {
            return Swamp.Direction.NONE;
        }
        double angle = Math.toDegrees(Math.atan2(-vy, vx));
        if (angle < 0) {
            angle += 360.0;
        }

        if (angle >= 337.5 || angle < 22.5) {
            return Swamp.Direction.E;
        }
        if (angle < 67.5) {
            return Swamp.Direction.NE;
        }
        if (angle < 112.5) {
            return Swamp.Direction.N;
        }
        if (angle < 157.5) {
            return Swamp.Direction.NW;
        }
        if (angle < 202.5) {
            return Swamp.Direction.W;
        }
        if (angle < 247.5) {
            return Swamp.Direction.SW;
        }
        if (angle < 292.5) {
            return Swamp.Direction.S;
        }
        if (angle < 337.5) {
            return Swamp.Direction.SE;
        }
        return Swamp.Direction.NONE;
    }

    private void setDirectionIfChanged(Swamp.Direction newDir) {
        if (newDir == null) {
            newDir = Swamp.Direction.NONE;
        }
        currentDirection = newDir;
    }

    public Swamp.Direction getHeroDirection() {
        return currentDirection;
    }

    private void checkStartIntersection() {
        if (startRect == null) {
            onStartRect = false;
            return;
        }
        boolean intersects = heroView.getBoundsInParent().intersects(startRect.getBoundsInParent());
        onStartRect = intersects;
        startRect.setFill(intersects ? Color.rgb(0, 120, 255, 0.42) : Color.rgb(0, 120, 255, 0.28));
    }

    private void updateCamera() {
        double heroCenterX = heroView.getLayoutX() + HERO_W / 2.0;
        double heroCenterY = heroView.getLayoutY() + HERO_H / 2.0;

        double targetTx = VIEW_W / 2.0 - heroCenterX;
        double targetTy = VIEW_H / 2.0 - heroCenterY;

        double minTx = Math.min(0, VIEW_W - worldW);
        double maxTx = 0;
        double minTy = Math.min(0, VIEW_H - worldH);
        double maxTy = 0;

        double tx = clamp(targetTx, minTx, maxTx);
        double ty = clamp(targetTy, minTy, maxTy);

        double lowerZone = worldH * 0.75;
        if (heroCenterY > lowerZone) {
            double factor = 0.45;
            ty = ty * factor + (VIEW_H / 2.0 - heroCenterY) * (1 - factor);
            ty = clamp(ty, minTy, maxTy);
        }

        world.setTranslateX(tx);
        world.setTranslateY(ty);
    }

    private static double clamp(double v, double lo, double hi) {
        if (v < lo) {
            return lo;
        }
        if (v > hi) {
            return hi;
        }
        return v;
    }

    private void clearInputState() {
        keys.clear();
    }

    public void startMapMusic() {
        try {
            stopMapMusic();
            URL res = getClass().getResource("/Resources/music/swampDungeon.mp3");
            boolean hasRes = res != null;
            if (hasRes) {
                Media media = new Media(res.toExternalForm());
                music = new MediaPlayer(media);
                music.setCycleCount(MediaPlayer.INDEFINITE);
                music.setVolume(MainScreen.getVolumeSetting());
                music.play();

                AudioManager.register(music);
            }
        } catch (Throwable ignored) {
        }
    }

    public void stopMapMusic() {
        try {
            boolean exists = music != null;
            if (exists) {
                AudioManager.unregister(music);
                music.stop();
                music.dispose();
                music = null;
            }
        } catch (Throwable ignored) {
        }
    }

    private void openDebugCombat() {
        String bg = "/Resources/textures/Battle/swampBattle.png";
        stopMapMusic();

        GUI.CombatScreen cs = new GUI.CombatScreen(game, bg, "Swamp", game.getHero());

        cs.setBattleMusicPath("/Resources/music/bossBattle2.mp3");
        //cs.setBattleMusicPath("/Resources/music/bossBattle2.mp3");

        cs.setOnExit(() -> {
            Platform.runLater(() -> {
                try {
                    FXGL.getGameScene().removeUINode(cs.root);
                } catch (Throwable ignored) {
                }
                try {
                    FXGL.getGameScene().addUINode(root);
                } catch (Throwable ignored) {
                }
                startMapMusic();
                root.requestFocus();
            });
        });

        Platform.runLater(() -> {
            try {
                FXGL.getGameScene().removeUINode(root);
            } catch (Throwable ignored) {
            }
            cs.show();
        });
    }

    private void drawDebugObstacles() {
        world.getChildren().removeIf(n -> "obstacle_debug".equals(n.getProperties().get("tag")));

        for (Swamp.Obstacle ob : obstacles) {
            Rectangle2D r = ob.collisionRect;
            Rectangle debug = new Rectangle(r.getMinX(), r.getMinY(), r.getWidth(), r.getHeight());
            debug.setFill(Color.color(1, 0, 0, 0.25));      // rojo semitransparente
            debug.setStroke(Color.color(1, 0, 0, 0.9));
            debug.setMouseTransparent(true);
            debug.getProperties().put("tag", "obstacle_debug");
            debug.getProperties().put("id", ob.id);
            world.getChildren().add(debug);
        }
        heroView.toFront();
    }

    // Para Cambiar la Imagen y borrar Colisiones
    private void createDungeonTriggerRects() {
        for (Rectangle r : dungeonTriggerRects) {
            try {
                world.getChildren().remove(r);
            } catch (Throwable ignored) {
            }
        }
        dungeonTriggerRects.clear();

        double[][] TRIGGERS = new double[][]{
            {0.0, 717.6104099999986},
            {0.0, 691.7929739999986},
            {0.0, 665.7872219999987},
            {0.0, 639.9653219999987},
            {0.0, 616.8038939999985},
            {0.0, 593.8139339999985},
            {0.0, 564.9118019999986},
            {0.0, 524.5869419999987}
        };

        for (int i = 0; i < TRIGGERS.length; i++) {
            double x = TRIGGERS[i][0];
            double y = TRIGGERS[i][1];
            double w = HERO_W + 8;
            double h = HERO_H + 8;
            Rectangle r = new Rectangle(x - 4, y - 4, w, h);
            r.setFill(Color.color(0, 0, 0, 0.0));
            r.setStroke(null);
            r.setMouseTransparent(true);
            r.getProperties().put("tag", "dungeon_trigger");
            r.getProperties().put("id", "dungeonTrigger" + (i + 1));
            dungeonTriggerRects.add(r);
            if (!world.getChildren().contains(r)) {
                world.getChildren().add(r);
            }
        }
        heroView.toFront();
    }

    private void checkDungeonTriggers() {
        boolean shouldSwitch = false;

        if (beforeDungeon) {
            double hx = heroView.getLayoutX();
            double hy = heroView.getLayoutY();
            Rectangle2D heroRect = new Rectangle2D(hx, hy, HERO_W, HERO_H);

            for (Rectangle trigger : dungeonTriggerRects) {
                Rectangle2D tr = new Rectangle2D(trigger.getX(), trigger.getY(), trigger.getWidth(), trigger.getHeight());
                if (heroRect.intersects(tr)) {
                    shouldSwitch = true;
                }
            }
        }

        if (shouldSwitch) {
            switchToDungeon();
        }
    }

    private void switchToDungeon() {
        if (beforeDungeon) {
            beforeDungeon = false;
            obstacles.clear();

            try {
                world.getChildren().removeIf(n -> {
                    Object tag = n.getProperties().get("tag");
                    return "obstacle_debug".equals(tag) || "dungeon_trigger".equals(tag) || "exit_area".equals(tag);
                });
            } catch (Throwable ignored) {
            }

            boolean bgOk = loadBackgroundImage("/Resources/textures/SwampDungeon/dungeonOutside.png");
            setHeroPosition(1104.0, 523.9160459999985);
            if (!world.getChildren().contains(heroView)) {
                world.getChildren().add(heroView);
            }
            heroView.toFront();
            updateCamera();
        }
    }

}
